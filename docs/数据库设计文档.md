# 脉动健康 · 数据库设计文档（FitPulse）

> **设计说明**：本项目基于智能体创作平台核心能力进行扩展。  
> 在整体架构设计上，会复用平台原有的用户、智能体、工作流、知识库等表结构，  
> 但本次课程提交的实际数据库脚本仅包含用户、智能体、会话和健康相关表，  
> 工作流、知识库以及拍照饮食相关表仅作为未来扩展设计，当前并未在 `fitpulse_db` 中创建。

---

## 1. 数据库概述

### 1.1 数据库信息
- **数据库名称**: `fitpulse_db`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **数据库引擎**: InnoDB
- **MySQL版本要求**: 8.0+

### 1.2 设计原则

1. **复用平台核心能力**  
    - 不重复造轮子，直接使用平台已有表结构（其中部分仅为预留设计）：
       - 用户表：`user`
       - 智能体表：`agent`, `agent_config`, `agent_usage`
       - 工作流相关：`workflow_instance`, `workflow_log`（平台预留，当前数据库未创建）
       - 知识库相关：`kb_category`, `kb_article`（平台预留，当前数据库未创建）
       - 会话管理：`conversation`, `message`
       - 权限管理：`role`, `permission`, `user_role`, `role_permission`
         - LLM 管理：`llm_provider`, `llm_model`

2. **健康业务清晰解耦**  
   - FitPulse 健康相关业务单独建表（**10张扩展表**）：
     - 健康档案：`health_profile`
     - 体重/BMI 记录：`weight_log`
     - 训练记录：`workout_log`
     - 睡眠记录：`sleep_log`
     - 饮食记录（按餐汇总）：`diet_log`
     - 饮食图片：`diet_photo`
     - 饮食明细（单个食物颗粒度）：`diet_food_item`
     - 健康计划：`health_plan`
     - 周度报告：`weekly_report`
     - 风险提醒：`risk_alert`

3. **面向 API 设计**  
   - 每个表清晰对应业务 API 端点，方便 Controller/Service 层映射；  
   - 拍照饮食功能的端到端链路为：

   > `diet_log`（一顿饭）  
   > ←→ `diet_photo`（多张图片）  
   > ←→ `diet_food_item`（多种食物明细）

4. **扩展性与安全性**  
   - 对结构经常变化的信息采用 `JSON` 字段（如计划配置、AI 分析结果、风险标签）
   - 所有健康数据通过 `user_id` 与 `user` 表关联
   - 智能体通过 `category`、`scope_tags` 与健康场景解耦
   - 为高血压/糖尿病等慢病预留风险标记字段（红/黄/绿灯 + `risk_tags`）

### 1.3 表分类总览

从整体设计视角看，平台 + FitPulse 共 **26 张核心表**（16 张复用 + 10 张新增）。  
其中 **实际随本项目创建的表** 以 `sql/01_schema.sql` 为准，知识库、工作流、饮食拍照识别、周度报告和风险提醒等表暂未在 `fitpulse_db` 中落地，仅保留为扩展设计。

| 模块 | 数量 | 表名 | 来源 |
|------|------|------|------|
| 用户与权限 | 5 | `user`, `role`, `permission`, `user_role`, `role_permission` | 复用平台 |
| 智能体核心 | 3 | `agent`, `agent_config`, `agent_usage` | 复用平台（扩展字段） |
| LLM 管理 | 2 | `llm_provider`, `llm_model` | 复用平台 |
| 知识库 | 2 | `kb_category`, `kb_article` | 平台预留设计，当前未在 `fitpulse_db` 中创建 |
| 会话管理 | 2 | `conversation`, `message` | 复用平台（扩展字段） |
| 工作流基础 | 2 | `workflow_instance`, `workflow_log` | 平台预留设计，当前未在 `fitpulse_db` 中创建 |
| 健康档案 | 1 | `health_profile` | FitPulse 新增 |
| 健康数据记录 | 4 | `weight_log`, `workout_log`, `sleep_log`, `diet_log` | FitPulse 新增 |
| 饮食拍照识别 | 2 | `diet_photo`, `diet_food_item` | FitPulse 预留设计（当前未实现） |
| 健康业务 | 3 | `health_plan`, `weekly_report`, `risk_alert` | 其中 `health_plan` 已实现；`weekly_report`、`risk_alert` 为预留设计 |
| **健康档案** | 1张 | health_profile | FitPulse 新增 |
| **健康数据记录** | 4张 | weight_log, workout_log, sleep_log, diet_log | FitPulse 新增 |
| **健康业务** | 3张 | health_plan, weekly_report, risk_alert | 仅 `health_plan` 随本项目落地，其余为预留设计 |

---

## 2. 核心实体关系总览

### 2.1 ER 关系说明（文字版）

**平台核心部分：**
```
user (1) ←→ (N) user_role ←→ (N) role
role (1) ←→ (N) role_permission ←→ (N) permission
user (1) ←→ (N) agent (创建者)
agent (1) ←→ (1) agent_config
agent (1) ←→ (N) agent_usage
agent (1) ←→ (N) conversation
user (1) ←→ (N) conversation
conversation (1) ←→ (N) message
kb_category (1) ←→ (N) kb_article
user (1) ←→ (N) workflow_instance
workflow_instance (1) ←→ (N) workflow_log

llm_provider (1) ←→ (N) llm_model
agent_config (N) ←→ (1) llm_model (默认模型)
message (N) ←→ (1) llm_model (实际使用模型)
```

**FitPulse 健康扩展部分：**
```
user (1) ←→ (1) health_profile
user (1) ←→ (N) weight_log
user (1) ←→ (N) workout_log
user (1) ←→ (N) sleep_log
user (1) ←→ (N) diet_log
user (1) ←→ (N) health_plan
user (1) ←→ (N) weekly_report
user (1) ←→ (N) risk_alert

diet_log   (1) ←→ (N) diet_photo
diet_log   (1) ←→ (N) diet_food_item

agent (1) ←→ (N) workout_log (教练指导)
agent (1) ←→ (N) health_plan (计划生成)
agent (1) ←→ (N) weekly_report (报告生成)
agent (1) ←→ (N) risk_alert (风险提醒)

```

> 说明：上述关系图中涉及的 `kb_category`、`kb_article`、`workflow_instance`、`workflow_log`、`diet_photo`、`diet_food_item`、`weekly_report`、`risk_alert` 等表，为未来扩展设计所用，当前课程提交版本的数据库脚本未创建这些表，代码中也未实现对应功能。

health_plan      (1) ←→ (N) workout_log (计划关联)
workflow_instance (1) ←→ (0-1) weekly_report
workflow_instance (1) ←→ (0-N) risk_alert
```

### 2.2 典型数据流示例

> **说明**：本节 2.2.1 ~ 2.2.4 描述的是理想状态下引入工作流引擎和拍照饮食识别后的数据流，仅作为架构预留。  
> 当前课程实现版本只覆盖「手动健康记录 + 基础计划生成」，不会实际落地 `workflow_*`、`diet_photo`、`diet_food_item`、`weekly_report`、`risk_alert` 等表。

#### 2.2.1 初次评估 & 计划生成（预留设计，当前实现未包含）
1. 用户填写/更新 `health_profile`
2. （预留）触发工作流 → `workflow_instance` 记录执行
3. （预留）工作流读取：`health_profile`, 最近的 `weight_log`, `workout_log`
4. （预留）工作流调用智能体（`agent`），生成训练/生活方式计划
5. 将结果写入 `health_plan`，前端通过 `/api/health/plans/current` 展示（当前版本由接口直接调用智能体生成，不依赖工作流表）

#### 2.2.2 周度健康报告（预留设计，当前实现未包含）
1. 每周定时任务执行，汇总：
   - `workout_log`（训练次数/时长/强度）
   - `weight_log`（体重变化）
   - `sleep_log`（平均睡眠）
   - `diet_log` + `diet_food_item`（本周红黄绿灯餐次）
2. 调用智能体生成周度报告 → 写入 `weekly_report`（预留表，当前未创建）
3. 用户登录后提示「有新的周报」（预留功能，当前未实现）

#### 2.2.3 风险识别与提醒（预留设计，当前实现未包含）
典型规则：
- 7 天体重变化超阈值（`weight_log`）
- 连续多天高强度训练（`workout_log`）
- 一周内红灯饮食次数过多（`diet_log` + `diet_food_item`）
- 对话中出现「胸痛、呼吸困难」等高危词（`message`）

触发后：
1. 创建 `workflow_instance`（类型 risk_alert）（预留表，当前未创建）
2. 可调用智能体生成提醒文案 → 写入 `risk_alert`（预留表，当前未创建）
3. 前端通过 `/api/health/alerts` 提示用户查看（预留接口，当前未实现）

#### 2.2.4 一日三餐拍照识别 & 红黄绿灯评估（预留设计，当前实现未包含）
1. 用户在「饮食记录」页选择日期 + 餐次，上传一张或多张图片
2. 后端创建 `diet_log` 记录（source_type = photo_ai）
3. 为每张图片创建 `diet_photo`（ai_status = pending）
4. 调用多模态模型（支持图像输入的 llm_model），得到食物识别结果 → 写回 `diet_photo.ai_result_json`
5. 解析识别结果，生成若干 `diet_food_item`：
   - food_name、estimated_weight、calories、protein/carbs/fat
   - traffic_light_level（单品红/黄/绿灯）
   - risk_tags（如 high_sodium/high_sugar）
6. 汇总所有 `diet_food_item`：
   - 计算本顿饭总热量与宏量营养素 → 更新 `diet_log.calories/protein/carbs/fat`
   - 结合用户目标及慢病风险→ 得到整体 traffic_light_level（绿/黄/红灯）
   - 填写解释 evaluation_reason 与整体 risk_tags

---

## 3. 平台复用表（简要说明）

> 以下表结构由平台提供，本项目在逻辑上使用，不重新定义。仅列出关键字段以便理解。

### 3.1 用户与权限模块（5张表）

#### 3.1.1 用户表 (user)
- **核心字段**：id, email, password, nickname, avatar_url, gender, birthday, status
- **用途**：用户账号、认证、基本信息
- **API 映射**：`/api/auth/login`, `/api/auth/register`, `/api/users/profile`

#### 3.1.2 角色表 (role)
- **核心字段**：id, role_name, role_desc
- **预置角色**：ROLE_ADMIN, ROLE_USER

#### 3.1.3 权限表 (permission)
- **核心字段**：id, permission_name, permission_desc, resource_type

#### 3.1.4 用户角色关联表 (user_role)
- **核心字段**：user_id, role_id

#### 3.1.5 角色权限关联表 (role_permission)
- **核心字段**：role_id, permission_id

---

### 3.2 智能体模块（3张表 - 扩展字段）

#### 3.2.1 智能体表 (agent) - **扩展字段**

**平台原有字段保持不变，新增以下字段以支持 FitPulse：**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| category | VARCHAR(50) | NOT NULL, 默认 'general' | 智能体类别：fitness_coach/nutrition/sleep/cardiovascular/diabetes/general |
| visibility | VARCHAR(20) | NOT NULL, 默认 'private' | 可见性：private/public_pending/public |
| scope_tags | JSON | NULL | 适用范围标签，如 ["减脂","增肌","心血管科普"] |

**说明**：
- `category` 区分不同类型的健康教练/顾问
- `visibility` 支持私有、申请公开、已公开三种状态
- `scope_tags` 存储智能体服务的健康场景标签（如减脂/增肌/睡眠等），不强绑定具体知识库表；当前项目未实现独立知识库模块

**API 映射**：
- `GET /api/agents?category=fitness_coach&visibility=public` - 获取官方/公开教练
- `POST /api/agents` - 用户创建个人教练/顾问

#### 3.2.2 智能体配置表 (agent_config)
- **核心字段**：agent_id, system_prompt, language_style, can_read_profile, kb_scope, llm_model_id, llm_config
- **扩展字段**：llm_model_id (BIGINT, 默认使用的 LLM 模型ID)
- **用途**：存储智能体的 Prompt、工具权限和默认 LLM 模型；其中 `kb_scope` 字段用于未来接入知识库能力时限定范围，当前实现未使用
- **外键**：llm_model_id REFERENCES llm_model(id)

#### 3.2.3 智能体使用记录表 (agent_usage)
- **核心字段**：agent_id, user_id, conversation_id, message_count, tokens_used
- **用途**：统计智能体使用情况

---

### 3.3 知识库模块（2张表，预留设计，当前实现未包含）

> 本模块用于未来引入 RAG 知识库能力时使用，当前版本的数据库脚本与后端代码均未创建或使用 `kb_category`、`kb_article` 表，可视为设计草案。

#### 3.3.1 知识分类表 (kb_category)
- **核心字段**：id, category_name, parent_id, category_type, description
- **预置分类**：减脂训练、增肌训练、营养膳食、心血管健康、糖尿病管理

#### 3.3.2 知识条目表 (kb_article)
- **核心字段**：id, category_id, title, content, summary, tags, embedding_vector
- **用途**：RAG 检索增强生成的知识来源

---

### 3.4 LLM 管理模块（2张表）

#### 3.4.1 LLM 提供商表 (llm_provider)

**表名**: `llm_provider`  
**说明**: 存储 LLM 服务提供商信息（如 OpenAI、Azure OpenAI、Claude、国产大模型等）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 提供商ID |
| provider_name | VARCHAR | 100 | UNIQUE, NOT NULL | - | 提供商名称（如 OpenAI, Azure, Anthropic, Alibaba） |
| provider_code | VARCHAR | 50 | UNIQUE, NOT NULL | - | 提供商代码（如 openai, azure, claude, qwen） |
| api_base_url | VARCHAR | 500 | NULL | NULL | API 基础地址 |
| auth_type | VARCHAR | 20 | NOT NULL | 'api_key' | 认证方式：api_key/oauth/custom |
| config_template | JSON | - | NULL | NULL | 配置模板（如需要哪些参数） |
| status | TINYINT | - | NOT NULL | 1 | 状态：0-禁用，1-启用 |
| sort_order | INT | - | NOT NULL | 0 | 排序 |
| description | TEXT | - | NULL | NULL | 描述 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_provider_name` (provider_name)
- UNIQUE KEY: `uk_provider_code` (provider_code)
- INDEX: `idx_status` (status)

**预置数据示例**:
```sql
INSERT INTO llm_provider (provider_name, provider_code, api_base_url, auth_type, description) VALUES 
('OpenAI', 'openai', 'https://api.openai.com/v1', 'api_key', 'OpenAI 官方 API'),
('Azure OpenAI', 'azure', NULL, 'api_key', 'Azure OpenAI Service'),
('Anthropic Claude', 'claude', 'https://api.anthropic.com/v1', 'api_key', 'Anthropic Claude 系列'),
('阿里云通义千问', 'qwen', 'https://dashscope.aliyuncs.com/api/v1', 'api_key', '阿里云大模型'),
('智谱 GLM', 'zhipu', 'https://open.bigmodel.cn/api/paas/v4', 'api_key', '智谱 AI ChatGLM');
```

**API 映射**:
- `GET /api/llm/providers` - 获取可用提供商列表
- `POST /api/llm/providers` - 添加新提供商（管理员）

---

#### 3.4.2 LLM 模型表 (llm_model)

**表名**: `llm_model`  
**说明**: 存储具体的 LLM 模型配置（如 GPT-4, Claude-3.5 等）

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 模型ID |
| provider_id | BIGINT | - | NOT NULL | - | 提供商ID |
| model_name | VARCHAR | 100 | NOT NULL | - | 模型名称（如 GPT-4 Turbo） |
| model_code | VARCHAR | 100 | NOT NULL | - | 模型代码（如 gpt-4-turbo-preview） |
| model_version | VARCHAR | 50 | NULL | NULL | 版本号（如 0125） |
| **能力参数** | | | | | |
| max_tokens | INT | - | NULL | NULL | 最大 token 数 |
| context_window | INT | - | NULL | NULL | 上下文窗口大小 |
| supports_functions | BOOLEAN | - | NOT NULL | FALSE | 是否支持 Function Calling |
| supports_vision | BOOLEAN | - | NOT NULL | FALSE | 是否支持视觉输入 |
| **定价** | | | | | |
| input_price_per_1k | DECIMAL | 10,6 | NULL | NULL | 输入价格（元/1K tokens） |
| output_price_per_1k | DECIMAL | 10,6 | NULL | NULL | 输出价格（元/1K tokens） |
| **配置** | | | | | |
| api_config | JSON | - | NULL | NULL | API 调用配置（endpoint, headers 等） |
| default_params | JSON | - | NULL | NULL | 默认参数（temperature, top_p 等） |
| **状态** | | | | | |
| status | TINYINT | - | NOT NULL | 1 | 状态：0-禁用，1-启用，2-测试中 |
| is_default | BOOLEAN | - | NOT NULL | FALSE | 是否为默认模型 |
| sort_order | INT | - | NOT NULL | 0 | 排序 |
| description | TEXT | - | NULL | NULL | 模型描述 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_provider_model` (provider_id, model_code)
- INDEX: `idx_status` (status)
- INDEX: `idx_is_default` (is_default)
- FOREIGN KEY: `fk_model_provider` (provider_id) REFERENCES llm_provider(id)

**default_params JSON 示例**:
```json
{
  "temperature": 0.7,
  "top_p": 0.9,
  "max_tokens": 2000,
  "frequency_penalty": 0.0,
  "presence_penalty": 0.0
}
```

**预置数据示例**:
```sql
INSERT INTO llm_model (provider_id, model_name, model_code, max_tokens, context_window, supports_functions, input_price_per_1k, output_price_per_1k, is_default) 
SELECT id, 'GPT-4 Turbo', 'gpt-4-turbo-preview', 4096, 128000, TRUE, 0.07, 0.21, TRUE FROM llm_provider WHERE provider_code = 'openai'
UNION ALL
SELECT id, 'GPT-3.5 Turbo', 'gpt-3.5-turbo', 4096, 16385, TRUE, 0.0035, 0.0105, FALSE FROM llm_provider WHERE provider_code = 'openai'
UNION ALL
SELECT id, 'Claude 3.5 Sonnet', 'claude-3-5-sonnet-20241022', 8192, 200000, TRUE, 0.021, 0.105, FALSE FROM llm_provider WHERE provider_code = 'claude'
UNION ALL
SELECT id, '通义千问-Max', 'qwen-max', 6000, 30000, TRUE, 0.028, 0.028, FALSE FROM llm_provider WHERE provider_code = 'qwen';
```

**API 映射**:
- `GET /api/llm/models?provider_id=&status=1` - 获取可用模型列表
- `GET /api/llm/models/default` - 获取默认模型
- `POST /api/llm/models` - 添加新模型（管理员）
- `PUT /api/llm/models/{id}` - 更新模型配置（管理员）

---

### 3.5 会话管理模块（2张表）

#### 3.5.1 会话表 (conversation)
- **核心字段**：id, user_id, agent_id, title, message_count, last_message_at
- **用途**：用户与智能体的对话会话

#### 3.5.2 消息表 (message)
- **核心字段**：id, conversation_id, role, content, context_data, kb_references, llm_model_id
- **扩展字段**：llm_model_id (BIGINT, 该消息使用的 LLM 模型ID)
- **用途**：存储对话消息、知识库引用及实际使用的 LLM 模型
- **外键**：llm_model_id REFERENCES llm_model(id)

---

### 3.6 工作流模块（2张基础表，预留设计，当前实现未包含）

> 本模块用于未来引入通用工作流/定时任务能力时使用，当前版本的数据库脚本未创建 `workflow_instance`、`workflow_log` 表，后端代码中也未接入实际工作流引擎。

#### 3.6.1 工作流实例表 (workflow_instance)
- **核心字段**：id, user_id, workflow_type, status, input_data, output_data
- **工作流类型**：initial_assessment, weekly_report, risk_alert

#### 3.6.2 工作流日志表 (workflow_log)
- **核心字段**：workflow_instance_id, step_name, step_status, step_input, step_output
- **用途**：记录工作流执行的详细步骤

---

## 4. FitPulse 健康扩展表设计（8张新增表）

### 4.1 健康档案表 (health_profile)

#### 4.1.1 表信息

**表名**: `health_profile`  
**说明**: 存储用户的基础健康信息和慢病风险信息（1:1 关联 user）

#### 4.1.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 档案ID |
| user_id | BIGINT | - | UNIQUE, NOT NULL | - | 用户ID，对应 user.id |
| **基础信息** | | | | | |
| height | DECIMAL | 5,2 | NULL | NULL | 身高（cm） |
| current_weight | DECIMAL | 5,2 | NULL | NULL | 当前体重（kg） |
| target_weight | DECIMAL | 5,2 | NULL | NULL | 目标体重（kg） |
| bmi | DECIMAL | 4,2 | NULL | NULL | BMI（自动计算） |
| **运动信息** | | | | | |
| fitness_level | VARCHAR | 20 | NULL | NULL | 运动经验：beginner/intermediate/advanced |
| weekly_workout_days | TINYINT | - | NULL | NULL | 每周可训练天数 |
| preferred_time | VARCHAR | 50 | NULL | NULL | 偏好训练时间段 |
| **健康状况** | | | | | |
| medical_conditions | TEXT | - | NULL | NULL | 已确诊疾病（仅作提示，不做诊断） |
| family_history | TEXT | - | NULL | NULL | 家族病史 |
| exercise_restrictions | TEXT | - | NULL | NULL | 运动禁忌 |
| has_cardiovascular_risk | TINYINT | 1 | NOT NULL | 0 | 是否关注心血管风险 |
| has_diabetes_risk | TINYINT | 1 | NOT NULL | 0 | 是否关注糖尿病风险 |
| **其他** | | | | | |
| health_goal | TEXT | - | NULL | NULL | 健康目标描述 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_user_id` (user_id)
- FOREIGN KEY: `fk_profile_user` (user_id) REFERENCES user(id) ON DELETE CASCADE

**触发器**: 自动计算BMI
```sql
DELIMITER $$
CREATE TRIGGER calc_bmi_before_update
BEFORE UPDATE ON health_profile
FOR EACH ROW
BEGIN
  IF NEW.height > 0 AND NEW.current_weight > 0 THEN
    SET NEW.bmi = NEW.current_weight / ((NEW.height / 100) * (NEW.height / 100));
  END IF;
END$$
DELIMITER ;
```

#### 4.1.3 典型 API

- `GET /api/health/profile` - 获取当前用户健康档案
- `PUT /api/health/profile` - 更新健康档案（当前版本仅更新档案字段，未接入工作流引擎）

---

### 4.2 体重记录表 (weight_log)

#### 4.2.1 表信息

**表名**: `weight_log`  
**说明**: 记录用户每日体重/BMI，用于曲线展示与风险分析

#### 4.2.2 字段设计


| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| record_date | DATE | - | NOT NULL | - | 记录日期 |
| weight | DECIMAL | 5,2 | NOT NULL | - | 体重（kg） |
| bmi | DECIMAL | 4,2 | NULL | NULL | BMI |
| body_fat_percentage | DECIMAL | 4,2 | NULL | NULL | 体脂率（%） |
| notes | VARCHAR | 200 | NULL | NULL | 备注 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_user_date` (user_id, record_date)
- FOREIGN KEY: `fk_weight_user` (user_id) REFERENCES user(id)

#### 4.2.3 典型 API

- `POST /api/health/weights` - 新增体重记录
- `GET /api/health/weights?startDate=&endDate=` - 查询体重曲线

---

### 4.3 训练记录表 (workout_log)

#### 4.3.1 表信息

**表名**: `workout_log`  
**说明**: 记录用户每日训练情况，支持与计划、智能体关联

#### 4.3.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| agent_id | BIGINT | - | NULL | NULL | 关联的智能体教练ID |
| plan_id | BIGINT | - | NULL | NULL | 关联的计划ID (health_plan.id) |
| workout_date | DATE | - | NOT NULL | - | 训练日期 |
| workout_type | VARCHAR | 50 | NULL | NULL | 训练类型：cardio/strength/hiit/mixed |
| title | VARCHAR | 200 | NULL | NULL | 训练标题/概述 |
| duration_minutes | INT | - | NULL | NULL | 训练时长（分钟） |
| intensity | VARCHAR | 20 | NULL | NULL | 强度：low/moderate/high |
| calories_burned | INT | - | NULL | NULL | 估算消耗能量(kcal) |
| status | VARCHAR | 20 | NOT NULL | 'completed' | 状态：completed/skipped/planned |
| notes | TEXT | - | NULL | NULL | 备注 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_user_date` (user_id, workout_date)
- INDEX: `idx_agent` (agent_id)
- INDEX: `idx_plan` (plan_id)
- FOREIGN KEY: `fk_workout_user` (user_id) REFERENCES user(id)
- FOREIGN KEY: `fk_workout_agent` (agent_id) REFERENCES agent(id)

#### 4.3.3 典型 API

- `POST /api/health/workouts` - 训练打卡
- `GET /api/health/workouts?startDate=&endDate=` - 查询训练记录

---

### 4.4 睡眠记录表 (sleep_log)

#### 4.4.1 表信息

**表名**: `sleep_log`  
**说明**: 记录用户每日睡眠时长与质量


#### 4.4.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| sleep_date | DATE | - | NOT NULL | - | 睡眠日期（对应起床日期） |
| sleep_hours | DECIMAL | 4,2 | NULL | NULL | 总睡眠时长（小时） |
| sleep_quality | TINYINT | - | NULL | NULL | 睡眠质量评分(1-5) |
| bed_time | TIME | - | NULL | NULL | 上床时间 |
| wake_time | TIME | - | NULL | NULL | 起床时间 |
| notes | TEXT | - | NULL | NULL | 备注（如失眠、夜醒次数） |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_user_date` (user_id, sleep_date)
- FOREIGN KEY: `fk_sleep_user` (user_id) REFERENCES user(id)

#### 4.4.3 典型 API

- `POST /api/health/sleeps` - 记录睡眠
- `GET /api/health/sleeps?startDate=&endDate=` - 查询睡眠数据

---

### 4.5 饮食记录模块（1 张已实现 + 2 张预留设计）

#### 4.5.1 饮食记录汇总表 diet_log

**说明**：以「一顿饭」为粒度；设计上兼容手动记录和拍照识别；  
当前版本仅实现手动记录及简单统计，拍照识别相关的 `diet_photo`、`diet_food_item` 表和功能为预留设计，未在数据库脚本中创建。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | PK, AUTO_INCREMENT | - | 记录 ID |
| user_id | BIGINT | - | NOT NULL | - | 用户 ID |
| meal_date | DATE | - | NOT NULL | - | 用餐日期 |
| meal_type | VARCHAR | 20 | NOT NULL | - | 餐次：breakfast/lunch/dinner/snack |
| source_type | VARCHAR | 20 | NOT NULL | 'manual' | 来源：manual / photo_ai |
| food_items | TEXT | - | NULL | NULL | 文本描述（手写或 AI 汇总） |
| calories | INT | - | NULL | NULL | 总卡路里（kcal） |
| protein | DECIMAL | 5,1 | NULL | NULL | 总蛋白质（g） |
| carbs | DECIMAL | 5,1 | NULL | NULL | 总碳水（g） |
| fat | DECIMAL | 5,1 | NULL | NULL | 总脂肪（g） |
| traffic_light_level | VARCHAR | 10 | NULL | NULL | 整体红黄绿灯：green / yellow / red |
| evaluation_reason | TEXT | - | NULL | NULL | 为什么是这个灯色的解释（AI 文本） |
| risk_tags | JSON | - | NULL | NULL | 风险标签集合，如 ["high_sodium","high_sugar"] |
| ai_analysis_json | JSON | - | NULL | NULL | AI 分析结构化摘要（可选缓存） |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PK: id
- IDX: idx_diet_user_date_meal (user_id, meal_date, meal_type)
- IDX: idx_diet_user_date (user_id, meal_date)

---

#### 4.5.2 饮食图片表 diet_photo（预留设计，当前实现未包含）

**说明**：存储与某一顿饭关联的图片及识别状态/结果；支持一餐多图。该表为拍照饮食识别功能预留设计，当前未在 `fitpulse_db` 中创建。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | PK, AUTO_INCREMENT | - | 图片记录 ID |
| diet_log_id | BIGINT | - | NOT NULL | - | 对应 diet_log.id |
| image_url | VARCHAR | 500 | NOT NULL | - | 原始图片 URL |
| thumbnail_url | VARCHAR | 500 | NULL | NULL | 缩略图 URL |
| ai_status | VARCHAR | 20 | NOT NULL | 'pending' | pending / processing / success / failed |
| ai_result_json | JSON | - | NULL | NULL | 原始识别结果（检测框、类别等） |
| error_message | VARCHAR | 500 | NULL | NULL | 识别失败原因 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PK: id
- IDX: idx_diet_photo_log (diet_log_id)
- IDX: idx_diet_photo_status (ai_status)

---

#### 4.5.3 饮食明细表 diet_food_item（预留设计，当前实现未包含）

**说明**：以「单个食物」为粒度，存储食物名称、分量、卡路里、单品红黄绿灯及慢病相关风险标签。该表为拍照饮食识别功能预留设计，当前未在 `fitpulse_db` 中创建。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | - | PK, AUTO_INCREMENT | - | 明细 ID |
| diet_log_id | BIGINT | - | NOT NULL | - | 所属饮食记录 ID (diet_log.id) |
| food_name | VARCHAR | 100 | NOT NULL | - | 食物名称，如「炸鸡翅」 |
| estimated_weight | DECIMAL | 6,1 | NULL | NULL | 估算重量（g） |
| unit | VARCHAR | 20 | NULL | NULL | 单位：g / ml / piece 等 |
| calories | INT | - | NULL | NULL | 卡路里（kcal） |
| protein | DECIMAL | 5,1 | NULL | NULL | 蛋白质（g） |
| carbs | DECIMAL | 5,1 | NULL | NULL | 碳水（g） |
| fat | DECIMAL | 5,1 | NULL | NULL | 脂肪（g） |
| traffic_light_level | VARCHAR | 10 | NULL | NULL | 单品红/黄/绿灯 |
| risk_tags | JSON | - | NULL | NULL | 风险标签，如 ["high_sodium"]、["high_sugar"] |
| ai_confidence | DECIMAL | 4,3 | NULL | NULL | 识别置信度（0~1） |
| extra_info | JSON | - | NULL | NULL | GI 值、食物类别等扩展信息 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PK: id
- IDX: idx_diet_item_log (diet_log_id)
- IDX: idx_diet_item_food_name (food_name)

---

#### 4.5.4 典型 API

- `POST /api/health/diets` - 手动记录饮食（当前版本已实现）
- `GET /api/health/diets/{id}` - 获取某一餐的详细信息（当前版本仅返回手动记录字段）
- `GET /api/health/diets?date=` - 查询某日的饮食记录

---

### 4.6 健康计划表 (health_plan)

#### 4.6.1 表信息

**表名**: `health_plan`  
**说明**: 存储智能体生成的训练/生活方式计划

#### 4.6.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 计划ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| agent_id | BIGINT | - | NULL | NULL | 生成该计划的智能体ID |
| plan_type | VARCHAR | 20 | NOT NULL | 'training' | 计划类型：training/lifestyle/mixed |
| title | VARCHAR | 200 | NOT NULL | - | 计划标题（如"30天减脂计划"） |
| description | TEXT | - | NULL | NULL | 简要描述 |
| plan_config | JSON | - | NULL | NULL | 结构化计划内容（按日/周拆分） |
| start_date | DATE | - | NULL | NULL | 计划开始日期 |
| end_date | DATE | - | NULL | NULL | 计划结束日期 |
| status | VARCHAR | 20 | NOT NULL | 'active' | 状态：active/completed/cancelled/draft |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_user_status` (user_id, status)
- INDEX: `idx_agent` (agent_id)
- FOREIGN KEY: `fk_plan_user` (user_id) REFERENCES user(id)
- FOREIGN KEY: `fk_plan_agent` (agent_id) REFERENCES agent(id)

#### 4.6.3 典型 API

- `POST /api/health/plans/generate` - 调用智能体生成新计划
- `GET /api/health/plans/current` - 获取当前生效计划
- `GET /api/health/plans/history` - 查看历史计划

---

### 4.7 周度健康报告表 (weekly_report)（预留设计，当前实现未包含）

#### 4.7.1 表信息

**表名**: `weekly_report`  
**说明**: 存储智能体生成的周度健康总结报告。该表及其相关接口为未来扩展设计，当前数据库脚本未创建 `weekly_report`，后端也未实现周报功能。

#### 4.7.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 报告ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| agent_id | BIGINT | - | NULL | NULL | 生成报告的智能体ID |
| workflow_instance_id | BIGINT | - | NULL | NULL | 关联的工作流实例ID |
| report_week | VARCHAR | 20 | NOT NULL | - | 报告周次（如2024-W48） |
| start_date | DATE | - | NOT NULL | - | 周起始日期 |
| end_date | DATE | - | NOT NULL | - | 周结束日期 |
| **统计数据** | | | | | |
| workout_count | INT | - | NOT NULL | 0 | 训练次数 |
| total_duration_minutes | INT | - | NOT NULL | 0 | 总训练时长 |
| weight_change | DECIMAL | 5,2 | NULL | NULL | 体重变化（kg） |
| avg_sleep_hours | DECIMAL | 3,1 | NULL | NULL | 平均睡眠时长 |
| **报告内容** | | | | | |
| summary | TEXT | - | NULL | NULL | 总体总结 |
| highlights | TEXT | - | NULL | NULL | 亮点与完成情况 |
| issues | TEXT | - | NULL | NULL | 存在问题 |
| suggestions | TEXT | - | NULL | NULL | 下周建议 |
| report_json | JSON | - | NULL | NULL | 结构化报告数据 |
| is_read | BOOLEAN | - | NOT NULL | FALSE | 是否已读 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_user_week` (user_id, report_week)
- INDEX: `idx_agent` (agent_id)
- FOREIGN KEY: `fk_report_user` (user_id) REFERENCES user(id)
- FOREIGN KEY: `fk_report_agent` (agent_id) REFERENCES agent(id)

#### 4.7.3 典型 API

- `GET /api/health/reports` - 按时间分页查看周报列表
- `GET /api/health/reports/{id}` - 查看指定周报详情

---

### 4.8 健康风险提醒表 (risk_alert)（预留设计，当前实现未包含）

#### 4.8.1 表信息

**表名**: `risk_alert`  
**说明**: 存储规则/工作流触发的健康或训练风险提醒。该表及其相关接口为未来扩展设计，当前数据库脚本未创建 `risk_alert`，后端也未实现自动风险提醒功能。

#### 4.8.2 字段设计

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PRIMARY KEY, AUTO_INCREMENT | - | 提醒ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| agent_id | BIGINT | - | NULL | NULL | 触发提醒的智能体ID |
| workflow_instance_id | BIGINT | - | NULL | NULL | 关联的工作流实例ID |
| alert_type | VARCHAR | 50 | NOT NULL | - | 提醒类型：weight_change/overtraining/symptom等 |
| severity | VARCHAR | 20 | NOT NULL | - | 严重程度：low/medium/high/critical |
| title | VARCHAR | 200 | NOT NULL | - | 提醒标题 |
| content | TEXT | - | NOT NULL | - | 提醒内容 |
| trigger_data | JSON | - | NULL | NULL | 触发数据（相关指标快照） |
| is_read | BOOLEAN | - | NOT NULL | FALSE | 是否已读 |
| is_dismissed | BOOLEAN | - | NOT NULL | FALSE | 是否已忽略 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_user_severity` (user_id, severity)
- INDEX: `idx_created_at` (created_at)
- FOREIGN KEY: `fk_alert_user` (user_id) REFERENCES user(id)
- FOREIGN KEY: `fk_alert_agent` (agent_id) REFERENCES agent(id)

#### 4.8.3 典型 API

- `GET /api/health/alerts` - 获取提醒列表（支持按已读筛选）
- `POST /api/health/alerts/{id}/read` - 标记为已读
- `POST /api/health/alerts/{id}/dismiss` - 忽略提醒

---

## 5. 表关系总览（完整版）

### 5.1 核心关系图

```
【平台核心】
user (1) ←→ (N) user_role ←→ (N) role
role (1) ←→ (N) role_permission ←→ (N) permission

user (1) ←→ (N) agent (创建者)
agent (1) ←→ (1) agent_config
agent (1) ←→ (N) agent_usage
agent (1) ←→ (N) conversation
user (1) ←→ (N) conversation
conversation (1) ←→ (N) message

llm_provider (1) ←→ (N) llm_model
agent_config (N) ←→ (1) llm_model (默认模型)
message (N) ←→ (1) llm_model (实际使用模型)

kb_category (1) ←→ (N) kb_article
kb_category (父子) → kb_category

user (1) ←→ (N) workflow_instance
workflow_instance (1) ←→ (N) workflow_log

【FitPulse 健康扩展】
user (1) ←→ (1) health_profile
user (1) ←→ (N) weight_log
user (1) ←→ (N) workout_log
user (1) ←→ (N) sleep_log
user (1) ←→ (N) diet_log
user (1) ←→ (N) health_plan
user (1) ←→ (N) weekly_report
user (1) ←→ (N) risk_alert

agent (1) ←→ (N) workout_log (教练指导)
agent (1) ←→ (N) health_plan (计划生成)
agent (1) ←→ (N) weekly_report (报告生成)
agent (1) ←→ (N) risk_alert (风险提醒)

health_plan (1) ←→ (N) workout_log (计划执行)
workflow_instance (1) ←→ (0-1) weekly_report
workflow_instance (1) ←→ (0-N) risk_alert
```

---

## 6. 数据库初始化与优化

### 6.1 创建数据库

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS fitpulse_db 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE fitpulse_db;
```

### 6.2 索引优化策略

| 查询场景 | 涉及表 | 推荐索引 |
|----------|--------|----------|
| 用户登录 | user | uk_email |
| 用户健康档案 | health_profile | uk_user_id |
| 体重曲线查询 | weight_log | idx_user_date |
| 训练记录统计 | workout_log | idx_user_date, idx_agent, idx_plan |
| 智能体市场列表 | agent | idx_category, idx_visibility, idx_status |
| 用户会话历史 | conversation | idx_user_agent |
| 知识库检索 | kb_article | ft_title_content, idx_category_id |
| 周报查询 | weekly_report | uk_user_week |
| 风险提醒 | risk_alert | idx_user_severity |
| LLM 模型列表 | llm_model | idx_status, idx_is_default |
| 按提供商查询模型 | llm_model | uk_provider_model |

### 6.3 分区策略（可选）

对于数据量大的表，可考虑按时间分区：

```sql
-- 示例：对 message 表按月分区
ALTER TABLE message
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    -- ... 持续添加
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 对 workout_log 表按年分区
ALTER TABLE workout_log
PARTITION BY RANGE (YEAR(workout_date)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 6.4 性能优化建议

**查询优化**:
- 避免 SELECT *，只查询需要的字段
- 合理使用 JOIN，避免 N+1 查询
- 大表查询使用分页（LIMIT + OFFSET）
- 使用 Redis 缓存热点数据（用户信息、智能体配置、健康档案等）

**连接池配置**:
```yaml
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### 6.5 数据安全与备份

**敏感数据加密**:
- 密码：BCrypt 加密存储（后端处理）
- 健康数据：可考虑 AES 加密敏感字段
- JWT Token：HMAC-SHA256 签名

**备份策略**:
```bash
# 每日全量备份
mysqldump -u root -p fitpulse_db > backup_$(date +%Y%m%d).sql

# 增量备份（启用 binlog）
mysql> SET GLOBAL binlog_format = 'ROW';
```

**数据保留策略**:
- 会话消息：保留 1 年后归档
- 工作流日志：保留 6 个月
- 用户删除：软删除，保留 90 天后物理删除

---

## 7. API 映射总览（与数据库对应）

### 7.1 健康业务 API

| API | 方法 | 相关表 | 说明 |
|-----|------|--------|------|
| /api/health/profile | GET/PUT | health_profile | 获取/更新健康档案 |
| /api/health/weights | GET/POST | weight_log | 查询/写入体重记录 |
| /api/health/workouts | GET/POST | workout_log | 查询/写入训练记录 |
| /api/health/sleeps | GET/POST | sleep_log | 查询/写入睡眠记录 |
| /api/health/diets | GET/POST | diet_log | 查询/手动记录饮食 |
| /api/health/diets/photo | POST | diet_log, diet_photo, diet_food_item | 上传图片并触发 AI 识别和红黄绿灯评估 |
| /api/health/diets/{id} | GET | diet_log, diet_photo, diet_food_item | 获取某一餐的详细信息 |
| /api/health/plans/generate | POST | health_plan, workflow_instance | 调用智能体生成计划 |
| /api/health/plans/current | GET | health_plan | 获取当前计划 |
| /api/health/plans/history | GET | health_plan | 查看历史计划 |
| /api/health/reports | GET | weekly_report | 周报列表 |
| /api/health/reports/{id} | GET | weekly_report | 周报详情 |
| /api/health/alerts | GET | risk_alert | 风险提醒列表 |
| /api/health/alerts/{id}/read | POST | risk_alert | 标记已读 |
| /api/health/alerts/{id}/dismiss | POST | risk_alert | 忽略提醒 |

### 7.2 智能体 & 会话 API

| API | 方法 | 相关表 | 说明 |
|-----|------|--------|------|
| /api/agents | GET/POST | agent, agent_config | 查询/创建智能体 |
| /api/agents/{id} | GET/PUT/DELETE | agent, agent_config | 详情/修改/删除 |
| /api/conversations | GET/POST | conversation | 查询/创建对话 |
| /api/conversations/{id}/messages | GET/POST | message | 查询/发送消息 |

### 7.3 LLM 管理 API

| API | 方法 | 相关表 | 说明 |
|-----|------|--------|------|
| /api/llm/providers | GET | llm_provider | 获取提供商列表 |
| /api/llm/models | GET | llm_model | 获取模型列表（可按提供商筛选） |
| /api/llm/models/default | GET | llm_model | 获取默认模型 |
| /api/llm/models/{id} | GET/PUT | llm_model | 模型详情/更新 |

---

## 8. 版本控制与迁移（Flyway 示例）

建议使用 Flyway 管理数据库版本：

```
db/migration/
├── V1.0.0__init_platform_tables.sql       # 平台核心表（user/agent/...）
├── V1.0.1__init_llm_tables.sql            # llm_provider / llm_model
├── V1.0.2__init_health_core_tables.sql    # health_profile, weight_log, workout_log, sleep_log, health_plan, weekly_report, risk_alert
├── V1.0.3__init_diet_tables.sql           # diet_log, diet_photo, diet_food_item
├── V1.0.4__extend_agent_message.sql       # agent、message 增加扩展字段
├── V1.0.5__add_indexes.sql                # 索引优化
└── V1.1.0__diet_traffic_light_update.sql  # 如后续调整红黄绿灯相关字段
```

## 9. 附录

### 9.1 完整 DDL 脚本文件

- `db_schema_platform.sql` - 平台核心表建表语句
- `db_schema_llm.sql` - LLM 提供商和模型表建表语句
- `db_schema_health.sql` - 健康扩展表建表语句
- `db_init_data.sql` - 初始化数据（角色、权限、官方智能体、LLM 提供商和模型等）
- `db_indexes.sql` - 索引优化脚本

### 9.2 测试数据脚本

- `db_test_users.sql` - 测试用户数据
- `db_test_agents.sql` - 测试智能体数据
- `db_test_health.sql` - 测试健康数据

---

## 9. 常见问题（FAQ）

### Q1：为什么饮食要拆成 diet_log / diet_photo / diet_food_item 三张表？
A：

- **diet_log**：一顿饭的视角，方便展示「今天吃了什么」「一周红黄绿灯情况」
- **diet_photo**：一餐多图，便于异步、多模态识别和调试图片问题
- **diet_food_item**：每个食物的结构化记录，便于做「高脂肪食物统计」「高钠食物统计」，并精细支持高血压/糖尿病等慢病饮食需求。

### Q2：红黄绿灯的判断逻辑放哪里？
A：

主要在业务层（Service），结合：

- 食物营养数据 (diet_food_item)
- 用户目标（减脂/增肌）与慢病风险（health_profile 中的 has_cardiovascular_risk / has_diabetes_risk）

结果写回：

- 单品级 → diet_food_item.traffic_light_level
- 餐级 → diet_log.traffic_light_level + evaluation_reason

### Q3：多模态识别模型的调用信息需要单独建表吗？
A：

若仅简单调用，可直接用：

- llm_model.supports_vision = TRUE
- diet_photo.ai_result_json 存原始返回

如后续需要记录详细调用日志，可考虑新增 llm_call_log 表，但目前不是必需。

### Q4: 为什么要复用平台表而不是从零设计？
A: 平台已提供成熟的用户、智能体、工作流、知识库能力，复用可以快速开发，专注于健康业务逻辑。

### Q5: 如何处理大量历史健康数据？
A: 采用分区策略 + 冷热数据分离，将旧数据归档到对象存储（如 S3）。

### Q6: 向量数据如何存储？
A: 建议使用专业向量数据库（如 Milvus、Pinecone），MySQL 中只存储向量 ID 引用。

### Q7: 智能体如何选择使用哪个 LLM 模型？
A: 智能体在 agent_config 表中配置默认的 llm_model_id。实际对话时，message 表记录每条消息使用的具体模型（支持动态切换）。用户也可以在创建智能体时选择特定的 LLM 模型。

### Q8: 如何管理 LLM 的 API Key 和调用配置？
A: API Key 等敏感信息建议存储在配置中心（如 Nacos）或环境变量中，不直接存储在数据库。llm_model 表的 api_config 字段仅存储非敏感的调用配置（如 endpoint、timeout 等）。

---

**文档版本**: V1.1.0  
**最后更新**: 2025-12-04  
**维护者**: FitPulse 开发团队
